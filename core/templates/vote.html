{% extends 'base.html' %}
{% load static %}

{% block title %}University Election - Vote{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8 p-6 bg-white rounded-lg shadow-lg">
  <h2 class="text-3xl font-bold mb-6 text-gray-800">University Election - Vote</h2>

  <form id="voteForm" method="POST" action="{% url 'vote' %}">
    {% csrf_token %}

    {% for position, candidates in candidates_by_position.items %}
      <div class="mb-8 border border-gray-200 rounded-lg shadow-sm">
        <div class="bg-blue-600 text-white px-5 py-3 rounded-t-lg">
          <h3 class="text-xl font-semibold">{{ position.name }}</h3>
        </div>
        <div class="p-5 space-y-4">
          {% for candidate in candidates %}
            <label for="candidate_{{ candidate.id }}" class="flex items-center space-x-4 cursor-pointer hover:bg-blue-50 rounded-lg p-3 transition">
              <input
                type="radio"
                name="position_{{ position.id }}"
                id="candidate_{{ candidate.id }}"
                value="{{ candidate.id }}"
                data-position-name="{{ position.name }}"
                class="form-radio h-5 w-5 text-blue-600"
              />
              <img
                src="{{ candidate.image.url }}"
                alt="{{ candidate.name }}"
                class="w-14 h-14 rounded-full object-cover border-2 border-gray-300"
              />
              <span class="text-lg font-medium text-gray-700">{{ candidate.name }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    <!-- Encrypted vote goes here -->
    <input type="hidden" name="encrypted_vote" id="encryptedVoteInput">

    <div class="flex justify-between">
      <button 
        type="button" 
        id="previewBtn"
        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
      >
        Preview Vote
      </button>
      <button 
        type="submit"
        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
      >
        Submit Vote
      </button>
    </div>
  </form>
</div>

<!-- Modal backdrop -->
<div id="previewModalBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="flex justify-between items-center border-b px-6 py-4">
      <h3 class="text-xl font-semibold text-gray-800">Vote Preview</h3>
      <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>
    <div id="previewBody" class="p-6 space-y-3 text-gray-700"></div>
    <div class="flex justify-end space-x-3 px-6 py-4 border-t">
      <button id="closeModalBtn2" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">Close</button>
      <button type="submit" form="voteForm" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">Confirm Vote</button>
    </div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>

<script>
  const nationalId = "{{ request.user.national_id }}";

  async function getPublicKey() {
    const response = await fetch("/api/public-key/");
    if (!response.ok) {
      throw new Error("Failed to fetch public key.");
    }
    const pem = await response.text();
    return forge.pki.publicKeyFromPem(pem);
  }

  async function encryptVoteData(votes) {
    try {
      const publicKey = await getPublicKey();
      const payload = JSON.stringify({ national_id: nationalId, votes: votes });
      const encrypted = publicKey.encrypt(payload, 'RSAES-PKCS1-V1_5');
      const encoded = forge.util.encode64(encrypted);
      return encoded;
    } catch (error) {
      console.error("Error in encryptVoteData:", error);
      throw error;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const voteForm = document.getElementById("voteForm");
    const previewModal = document.getElementById("previewModal");
    const previewModalBackdrop = document.getElementById("previewModalBackdrop");
    const previewBody = document.getElementById("previewBody");
    const encryptedInput = document.getElementById("encryptedVoteInput");
    const previewBtn = document.getElementById("previewBtn");
    const closeModalBtns = [document.getElementById("closeModalBtn"), document.getElementById("closeModalBtn2")];

    function openModal() {
      previewModal.classList.remove("hidden");
      previewModalBackdrop.classList.remove("hidden");
    }
    function closeModal() {
      previewModal.classList.add("hidden");
      previewModalBackdrop.classList.add("hidden");
    }

    previewBtn.addEventListener("click", () => {
      const selections = {};
      const positionNames = new Set();
      const inputs = voteForm.querySelectorAll('input[type="radio"]');

      let allSelected = true;

      inputs.forEach(input => {
        positionNames.add(input.name);
      });

      for (const name of positionNames) {
        const selected = voteForm.querySelector(`input[name="${name}"]:checked`);
        if (!selected) {
          allSelected = false;
          break;
        } else {
          selections[name] = selected.value;
        }
      }

      if (!allSelected) {
        alert("Please select a candidate for all positions before previewing.");
        return;
      }

      let html = "<ul class='list-disc pl-5 space-y-1'>";
      for (const name of positionNames) {
        const selected = voteForm.querySelector(`input[name="${name}"]:checked`);
        const label = voteForm.querySelector(`label[for="${selected.id}"]`);
        const posName = selected.dataset.positionName;
        const candidateName = label ? label.textContent.trim() : selected.value;
        html += `<li><strong>${posName}:</strong> ${candidateName}</li>`;
      }
      html += "</ul>";
      previewBody.innerHTML = html;

      openModal();
    });

    closeModalBtns.forEach(btn => btn.addEventListener("click", closeModal));
    previewModalBackdrop.addEventListener("click", closeModal);

    voteForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const selections = {};
      const inputs = voteForm.querySelectorAll('input[type="radio"]:checked');

      inputs.forEach(input => {
        const positionId = input.name.replace("position_", "");
        selections[positionId] = input.value;
      });

      if (Object.keys(selections).length === 0) {
        alert("Please select at least one candidate before submitting.");
        return;
      }

      try {
        const encrypted = await encryptVoteData(selections);
        if (!encrypted) {
          alert("Encryption failed: empty result.");
          return;
        }
        encryptedInput.value = encrypted;
        voteForm.submit();
      } catch (err) {
        console.error("Encryption error:", err);
        alert("Encryption failed. Please try again.");
      }
    });
  });
</script>
{% endblock %}
